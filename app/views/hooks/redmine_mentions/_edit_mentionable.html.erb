<%= javascript_include_tag 'jquery.textcomplete.min.js', :plugin => 'redmine_mentions' %>
<%= javascript_include_tag 'jquery.overlay.min.js', :plugin => 'redmine_mentions' %>
<%= stylesheet_link_tag 'auto_complete.css', plugin: 'redmine_mentions' %>

<script>
  $(document).ready(function() {
    <% trigger = Regexp.escape(Setting.plugin_redmine_mentions['trigger']) %>
    <% users = if User.active.select { |u| u.is_a?(User) && !u.mail.empty? }
               end %>
    <% users_regex = users.map { |u| "#{trigger}#{u.login}" }.join('|') %>
    
    $('#issue_notes,#issue_description').textcomplete([
      {
        mentions: <%= users.map { |u| "#{u.firstname} #{u.lastname} - <small>#{u.login}</small>" }.to_json %>,
        match: new RegExp('\\B' + <%= trigger %> + '(\\w|[.])*)$', 'i'),
        search: function(term, callback) {
          var matches = this.mentions.filter(function(mention) {
            return mention.toLowerCase().indexOf(term.toLowerCase()) !== -1;
          });
          callback(matches);
        },
        index: 1,
        replace: function(mention) {
          var parts = mention.split(' - ');
          var name = parts[1].substring(parts[1].lastIndexOf("<small>") + 7, parts[1].lastIndexOf("</small>"));
          return '<%= trigger %>' + name + ' ';
        }
      }
    ]);
    
    if (typeof CKEDITOR === 'undefined') { //fix CKEditor compatibility issue
      $('#issue_notes,#issue_description').overlay([
        {
          match: new RegExp('\\B(' + <%= users_regex %> + ')\\b', 'g'),
          css: {
            'background-color': '#C6D5F3',
          }
        }
      ]);
    }
  });
</script>
